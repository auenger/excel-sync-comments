# Excel 批注同步工具 - 开发者文档

## 📦 项目结构

```
pyexcel/
├── sync_comments.py          # 主程序
├── config.ini                # 配置文件
├── build_exe.py              # 打包脚本
├── create_distribution.py    # 分发包创建脚本
├── 使用说明.md               # 用户使用说明
├── 打包说明.md               # 打包说明
├── source.xlsx               # 源文件（示例）
├── target.xlsx               # 目标文件（示例）
├── dist/                     # 打包后的可执行文件
│   └── 批注同步工具
├── build/                    # 打包临时文件
└── 批注同步工具_macOS_YYYYMMDD.zip  # 分发包
```

## 🚀 完整工作流程

### 1. 开发阶段

```bash
# 激活虚拟环境
source ../.venv/bin/activate

# 安装依赖
pip install openpyxl

# 测试运行
python sync_comments.py
```

### 2. 打包阶段

```bash
# 方法一：使用自动打包脚本（推荐）
python build_exe.py

# 方法二：手动打包
pip install pyinstaller
pyinstaller --onefile --name=批注同步工具 --clean --add-data=config.ini:. sync_comments.py
```

### 3. 创建分发包

```bash
# 创建包含所有文件的分发包
python create_distribution.py
```

这会生成：
- `批注同步工具_macOS_YYYYMMDD/` 文件夹
- `批注同步工具_macOS_YYYYMMDD.zip` 压缩包

## 🔧 核心功能

### 1. 配置文件支持

脚本会从 `config.ini` 读取配置，支持：
- 文件路径配置
- 列配置
- 筛选条件
- 数据设置
- 批注合并设置

**优点**：用户修改配置后无需重新打包

### 2. 批注同步逻辑

```python
# 1. 加载源文件和目标文件
# 2. 根据区域和姓名建立索引
# 3. 遍历目标文件，匹配姓名
# 4. 同步批注（支持合并）
# 5. 生成详细日志
```

### 3. 批注合并

当目标单元格已有批注时：
- **启用合并**：原批注 + 分隔符 + 新批注
- **禁用合并**：直接覆盖

### 4. 日志记录

自动生成详细日志文件，包含：
- 配置信息
- 统计信息
- 详细操作记录
- 合并批注详情

## 📝 配置文件格式

```ini
[文件路径]
源文件 = source.xlsx
目标文件 = target.xlsx
输出文件 = target_updated.xlsx

[列配置]
区域列 = C
姓名列 = B
同步列 = DO, DP, DS, DU

[筛选条件]
筛选区域 = 厦门, 福州, 泉州

[数据设置]
数据起始行 = 3

[批注合并]
启用合并 = True
分隔符 = \n---\n
```

## 🔄 修改配置流程

### 用户端（无需重新打包）

1. 打开 `config.ini`
2. 修改相应配置
3. 保存文件
4. 重新运行工具

### 开发端（需要重新打包）

只有在修改 `sync_comments.py` 代码逻辑时才需要重新打包：

```bash
python build_exe.py
python create_distribution.py
```

## 🎯 分发给用户

### 分发包内容

```
批注同步工具_macOS_20260107.zip
├── 批注同步工具（可执行文件，4.2MB）
├── config.ini（配置文件）
├── 使用说明.md
├── 使用说明.txt
├── 快速开始.txt
└── 示例文件/
    ├── source.xlsx
    └── target.xlsx
```

### 用户使用步骤

1. 解压 zip 文件
2. 将自己的 Excel 文件放入文件夹
3. 修改 `config.ini`（可选）
4. 双击运行可执行文件
5. 查看生成的结果文件和日志

## 🔍 技术细节

### 依赖库

- `openpyxl`: Excel 文件读写
- `configparser`: 配置文件解析（Python 标准库）
- `datetime`: 时间戳（Python 标准库）

### 打包工具

- `PyInstaller`: 将 Python 脚本打包成可执行文件
- 打包后大小约 4-5MB（包含 Python 运行时）

### 跨平台支持

- **macOS**: 当前打包
- **Windows**: 需要在 Windows 系统上重新打包
- **Linux**: 需要在 Linux 系统上重新打包

## 🐛 常见问题

### Q1: 如何在 Windows 上打包？

在 Windows 系统上执行相同的打包命令：
```bash
python build_exe.py
```

生成的文件名会是 `批注同步工具.exe`

### Q2: 如何添加新功能？

1. 修改 `sync_comments.py`
2. 如果需要新的配置项，更新 `config.ini` 和配置加载逻辑
3. 测试功能
4. 重新打包
5. 创建新的分发包

### Q3: 如何减小打包后的文件大小？

PyInstaller 打包会包含整个 Python 运行时，文件较大是正常的。
如果需要减小大小，可以：
- 使用 `--exclude-module` 排除不需要的模块
- 使用 UPX 压缩（可能不稳定）

### Q4: 配置文件丢失怎么办？

脚本内置了默认配置，即使配置文件丢失也能正常运行。

## 📊 性能优化

当前实现已经比较高效：
- 使用字典索引加速查找
- 只遍历一次源文件和目标文件
- 批量写入，最后统一保存

对于大文件（10000+ 行），处理时间通常在几秒内。

## 🔐 安全性

- 不会修改源文件
- 输出到新文件，不会覆盖目标文件
- 所有操作都有日志记录

## 📅 版本历史

### v1.0 (2026-01-07)
- ✅ 基础批注同步功能
- ✅ 多区域筛选支持
- ✅ 批注智能合并
- ✅ 配置文件支持
- ✅ 详细日志记录
- ✅ 可执行文件打包
- ✅ 分发包自动创建

## 📞 维护建议

1. **定期备份**：保留源代码和配置文件
2. **版本管理**：使用 git 管理代码变更
3. **测试**：每次修改后都要测试
4. **文档更新**：修改功能后更新使用说明

---

**开发者**: Ryan  
**创建日期**: 2026-01-07  
**Python 版本**: 3.9+  
**许可证**: 内部使用
